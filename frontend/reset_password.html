<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Gabarito&display=swap">
    <link rel="stylesheet" href="styles/register.css">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <title>Reset Password</title>
</head>

<body>
    <div class="title">
        Reset Your <br>
        Password
    </div>

    <section class="container" x-data="{ accountVerified: false }" 
             x-bind:style="{ height: accountVerified ? '360px' : '250px' }"
             x-on:account-verified.window="console.log('Account verified event received'); accountVerified = true">
        
        <!-- Verification Form -->
        <form class="container-register" id="verify-form" 
              hx-post="/api/check-account"
              hx-trigger="submit"
              hx-target="#verify-response"
              hx-ext='json-enc'
              hx-headers='{"Content-Type": "application/json"}'
              @submit.prevent>
            
            <div class="input-box">
                <label>Username</label>
                <input type="text" name="username" required>
            </div>
            <div class="input-box">
                <label>Email</label>
                <input type="email" name="email" required>
            </div>

            <button class="submit-btn" type="submit">Verify Account</button>
        </form>

        <div id="verify-response"></div>

        <!-- Reset Password Form (Shown After Verification) -->
        <form class="container-register" id="reset-form" 
              x-show="accountVerified"
              hx-post="/api/reset-password"
              hx-trigger="submit"
              hx-target="#reset-response"
              hx-ext='json-enc'
              hx-headers='{"Content-Type": "application/json"}'
              @submit.prevent
              style="margin-top: 20px;">
            
            <div class="input-box">
                <label>Email</label>
                <input type="email" name="email" required>
            </div>
            <div class="input-box">
                <label>New Password</label>
                <input type="password" name="new_password" required>
            </div>

            <button class="submit-btn" type="submit">Reset Password</button>
        </form>

        <!-- Response from Reset Password -->
        <div id="reset-response"></div>
    </section>

    <script>
        // TODO: FIX THIS NOTHING WORKS NOW
        document.addEventListener('htmx:afterRequest', (event) => {
            const targetId = event.detail.elt.getAttribute('hx-target');
            const responseDiv = document.querySelector(targetId);
            const response = JSON.parse(event.detail.xhr.responseText);

            if (targetId === '#verify-response' || targetId === '#reset-response') {
                if (event.detail.successful) {
                    if (response.success) {
                        if (targetId === '#verify-response') {
                            // Dispatch event to update accountVerified
                            console.log('Dispatching account-verified event');
                            document.dispatchEvent(new CustomEvent('account-verified'));

                            responseDiv.textContent = "Account verified. Please enter your new password.";
                        } else if (targetId === '#reset-response') {
                            responseDiv.textContent = "Password has been reset successfully!";
                            
                            setTimeout(() => {
                                window.location.href = "/register";
                            }, 2000);
                        }
                    } else {
                        responseDiv.textContent = response.message || "An error occurred.";
                    }
                } else {
                    responseDiv.textContent = "An error occurred during the request.";
                }
            }
        });
    </script>
</body>

</html>